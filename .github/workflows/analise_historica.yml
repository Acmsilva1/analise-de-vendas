name: Gera√ß√£o de Dashboard Hist√≥rico Mensal

# 1. QUANDO RODAR (GATILHO)
on:
  schedule:
    # Roda no primeiro dia de cada m√™s, √†s 03:00 UTC (Meia-noite BRT)
    - cron: '0 3 1 * *' 
  
  # Permite que voc√™ o acione manualmente para testes
  workflow_dispatch:

# 2. OS TRABALHOS (JOB)
jobs:
  run_monthly_historical_analysis:
    
    # PERMISS√ÉO DE ESCRITA: Corrigiu o erro 403
    permissions:
      contents: write 
    
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout C√≥digo
        uses: actions/checkout@v4

      # üêç Configura√ß√£o do ambiente Python e Instala√ß√£o de depend√™ncias
      - name: Set up Python e Instalar Depend√™ncias
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' 
      
      - name: Instalar gspread e PANDAS (requirements.txt)
        run: pip install -r requirements.txt

      # üîê CRIA O ARQUIVO DE CREDENCIAIS (FIX JSON ERROR)
      # Usa uma vari√°vel de ambiente intermedi√°ria para injetar o JSON limpo no arquivo
      - name: Criar Arquivo de Credenciais
        run: |
          # Usa 'echo' para obter o valor, 'tr -d' para remover quebras de linha (\n) e retornos de carro (\r), e salva no arquivo.
          echo "$JSON_CREDS" | tr -d '\n\r' > credenciais.json
        env:
          JSON_CREDS: ${{ secrets.GOOGLE_CREDENTIALS }}
        
      # üöÄ EXECU√á√ÉO DO SCRIPT DE AN√ÅLISE HIST√ìRICA
      - name: Executar An√°lise Hist√≥rica e Gerar HTML
        run: python analise_historica.py
        
      # üíæ PUBLICA√á√ÉO DO NOVO DASHBOARD HTML
      - name: Commit do Dashboard Hist√≥rico Atualizado
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Feat: Dashboard Hist√≥rico e Tend√™ncias atualizado (Mensal)"
          # Par√¢metro corrigido para o nome do arquivo
          file_pattern: dashboard_historico.html
